name: Full DevSecOps Pipeline (Mirror + Trivy + Sonar + OWASP + Notify)

on:
  workflow_dispatch:
  push:
    branches: ["main"]
    paths-ignore:
      - "Kubernetes/deployment.yml"

permissions:
  contents: write
  pull-requests: write

env:
  SOURCE_IMAGE: mostafagheta/netflix-clone:latest
  TARGET_REPO: sohila11/netflix-clone
  APP_DIR: Source-Code/Application-Code

jobs:
  mirror_trivy_push_gitops:
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.vars.outputs.tag }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set image tag
        id: vars
        run: |
          SHORT_SHA="${GITHUB_SHA::7}"
          echo "tag=main-${SHORT_SHA}" >> "$GITHUB_OUTPUT"

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Pull source image (Mostafa)
        run: docker pull "${SOURCE_IMAGE}"

      - name: Tag image for my DockerHub
        run: docker tag "${SOURCE_IMAGE}" "${TARGET_REPO}:${{ steps.vars.outputs.tag }}"

      - name: Trivy scan (image)
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8
        with:
          image-ref: "${{ env.TARGET_REPO }}:${{ steps.vars.outputs.tag }}"
          format: "table"
          exit-code: "0"
          vuln-type: "os,library"
          severity: "CRITICAL,HIGH,MEDIUM"

      - name: Push image to my DockerHub
        run: docker push "${TARGET_REPO}:${{ steps.vars.outputs.tag }}"

      - name: Update K8s deployment image (GitOps change)
        run: |
          set -e
          FILE="Kubernetes/deployment.yml"
          NEW_IMAGE="${TARGET_REPO}:${{ steps.vars.outputs.tag }}"
          perl -0777 -pi -e "s|(^\\s*image:\\s*).*$|\\1$NEW_IMAGE|mg" "$FILE"
          echo "Updated image to: $NEW_IMAGE"
          grep -n "image:" "$FILE" | head -n 5

      - name: Commit & push GitOps branch (manual PR link)
        env:
          TAG: ${{ steps.vars.outputs.tag }}
        run: |
          set -euo pipefail

          BRANCH="gitops/deploy-${TAG}"
          FILE="Kubernetes/deployment.yml"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add "$FILE"
          if git diff --cached --quiet; then
            echo "No manifest changes. Skipping."
            exit 0
          fi

          git checkout -b "$BRANCH"
          git commit -m "chore(gitops): deploy image ${TARGET_REPO}:${TAG}"
          git push -u origin "$BRANCH"

          echo "=================================================="
          echo "Branch pushed: $BRANCH"
          echo "Create PR manually:"
          echo "https://github.com/${GITHUB_REPOSITORY}/pull/new/${BRANCH}"
          echo "=================================================="

  sonarcloud:
    runs-on: ubuntu-latest
    needs: [mirror_trivy_push_gitops]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate Sonar vars
        run: |
          if [ -z "${{ vars.SONAR_ORG }}" ]; then
            echo "ERROR: vars.SONAR_ORG is missing."
            echo "Go to: Settings -> Secrets and variables -> Actions -> Variables"
            echo "Add variable SONAR_ORG with your SonarCloud organization key."
            exit 1
          fi
          if [ -z "${{ vars.SONAR_PROJECT_KEY }}" ]; then
            echo "ERROR: vars.SONAR_PROJECT_KEY is missing."
            echo "Go to: Settings -> Secrets and variables -> Actions -> Variables"
            echo "Add variable SONAR_PROJECT_KEY with your SonarCloud project key."
            exit 1
          fi
          if [ -z "${{ secrets.SONAR_TOKEN }}" ]; then
            echo "ERROR: secrets.SONAR_TOKEN is missing."
            exit 1
          fi

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: ${{ env.APP_DIR }}/package-lock.json

      - name: Install deps (for analysis)
        working-directory: ${{ env.APP_DIR }}
        run: npm ci

      # Optional: generate coverage if you want Sonar to read it
      # - name: Run tests with coverage (optional)
      #   working-directory: ${{ env.APP_DIR }}
      #   run: npm test -- --coverage

      - name: SonarCloud Scan (Application-Code only)
        uses: SonarSource/sonarcloud-github-action@v3
        env:
         SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
         args: >
           -Dsonar.organization=${{ vars.SONAR_ORG }}
           -Dsonar.projectKey=${{ vars.SONAR_PROJECT_KEY }}


  owasp_dependency_check:
    runs-on: ubuntu-latest
    needs: [mirror_trivy_push_gitops]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: OWASP Dependency-Check (Node)
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: "netflix-devsecops"
          path: "${{ env.APP_DIR }}"
          format: "HTML"
          out: "reports"

      - name: Upload OWASP report
        uses: actions/upload-artifact@v4
        with:
          name: owasp-dependency-check-report
          path: reports

  notify_on_failure:
    runs-on: ubuntu-latest
    needs: [mirror_trivy_push_gitops, sonarcloud, owasp_dependency_check]
    if: failure()

    steps:
      - name: Notify Slack (optional)
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -z "${SLACK_WEBHOOK_URL}" ]; then
            echo "SLACK_WEBHOOK_URL not set - skipping"
            exit 0
          fi
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"❌ DevSecOps pipeline failed on ${GITHUB_REPOSITORY} @ ${GITHUB_SHA::7}.\"}" \
            "${SLACK_WEBHOOK_URL}"

      - name: Notify Teams (optional)
        env:
          TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}
        run: |
          if [ -z "${TEAMS_WEBHOOK_URL}" ]; then
            echo "TEAMS_WEBHOOK_URL not set - skipping"
            exit 0
          fi
          curl -H "Content-Type: application/json" \
            -d "{\"text\":\"❌ DevSecOps pipeline failed on ${GITHUB_REPOSITORY} @ ${GITHUB_SHA::7}.\"}" \
            "${TEAMS_WEBHOOK_URL}"
