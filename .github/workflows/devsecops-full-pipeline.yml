name: Full DevSecOps Pipeline (Mirror + Trivy + Sonar + OWASP + Notify)

on:
  workflow_dispatch:
  push:
    branches: ["main"]
    paths-ignore:
      - "Kubernetes/deployment.yml"

permissions:
  contents: write
  pull-requests: write

env:
  SOURCE_IMAGE: mostafagheta/netflix-clone:latest
  APP_DIR: Source-Code/Application-Code

  AWS_REGION: us-east-1
  AWS_ACCOUNT_ID: "734468801857"
  ECR_REGISTRY: 734468801857.dkr.ecr.us-east-1.amazonaws.com
  ECR_REPO: nti_project

jobs:
  mirror_trivy_push_gitops:
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.vars.outputs.tag }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set image tag
        id: vars
        run: |
          SHORT_SHA="${GITHUB_SHA::7}"
          echo "tag=main-${SHORT_SHA}" >> "$GITHUB_OUTPUT"

      - name: Debug AWS secrets presence
        shell: bash
        run: |
          test -n "${{ secrets.AWS_ACCESS_KEY_ID }}" && echo "✅ AWS_ACCESS_KEY_ID exists" || (echo "❌ AWS_ACCESS_KEY_ID missing" && exit 1)
          test -n "${{ secrets.AWS_SECRET_ACCESS_KEY }}" && echo "✅ AWS_SECRET_ACCESS_KEY exists" || (echo "❌ AWS_SECRET_ACCESS_KEY missing" && exit 1)

      - name: Configure AWS credentials (IAM User)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Verify AWS identity
        run: aws sts get-caller-identity

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Pull source image (Mostafa)
        run: docker pull "${SOURCE_IMAGE}"

      - name: Tag image for ECR
        run: |
          ECR_IMAGE="${ECR_REGISTRY}/${ECR_REPO}:${{ steps.vars.outputs.tag }}"
          docker tag "${SOURCE_IMAGE}" "${ECR_IMAGE}"
          echo "ECR_IMAGE=${ECR_IMAGE}" >> $GITHUB_ENV
          echo "Using ECR_IMAGE=${ECR_IMAGE}"

      - name: Trivy scan (image)
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8
        with:
          image-ref: "${{ env.ECR_IMAGE }}"
          format: "table"
          output: "trivy-image-report.txt"
          exit-code: "0"
          vuln-type: "os,library"
          severity: "CRITICAL,HIGH,MEDIUM"

      - name: Upload Trivy report (artifact)
        uses: actions/upload-artifact@v4
        with:
          name: trivy-image-report
          path: trivy-image-report.txt

      - name: Push image to ECR
        run: docker push "${ECR_IMAGE}"

      - name: Update K8s deployment image (GitOps change)
        run: |
          set -e
          FILE="Kubernetes/deployment.yml"
          NEW_IMAGE="${{ env.ECR_IMAGE }}"
          perl -0777 -pi -e "s|(^\\s*image:\\s*).*$|\\1$NEW_IMAGE|mg" "$FILE"
          echo "Updated image to: $NEW_IMAGE"
          grep -n "image:" "$FILE" | head -n 5

      - name: Commit & push GitOps branch (manual PR link)
        env:
          TAG: ${{ steps.vars.outputs.tag }}
        run: |
          set -euo pipefail

          BRANCH="gitops/deploy-${TAG}"
          FILE="Kubernetes/deployment.yml"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add "$FILE"
          if git diff --cached --quiet; then
            echo "No manifest changes. Skipping."
            exit 0
          fi

          git checkout -b "$BRANCH"
          git commit -m "chore(gitops): deploy image ${ECR_IMAGE}"
          git push -u origin "$BRANCH"

          echo "=================================================="
          echo "Branch pushed: $BRANCH"
          echo "Create PR manually:"
          echo "https://github.com/${GITHUB_REPOSITORY}/pull/new/${BRANCH}"
          echo "=================================================="

  sonarqube_local:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: self-hosted
    needs: [mirror_trivy_push_gitops]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify SonarQube is reachable (local)
        shell: bash
        run: |
          curl -I http://localhost:9000 | head -n 5

      - name: Recognize App path
        shell: bash
        run: |
          echo "APP_DIR=${{ env.APP_DIR }}"
          ls -la "${{ env.APP_DIR }}" | head
          test -d "${{ env.APP_DIR }}/src" && echo "✅ src exists" || (echo "❌ src missing" && exit 1)

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: ${{ env.APP_DIR }}/package-lock.json

      - name: Install deps
        working-directory: ${{ env.APP_DIR }}
        shell: bash
        run: npm ci

      - name: Run tests with coverage (Vitest)
        working-directory: ${{ env.APP_DIR }}
        shell: bash
        run: npm run test:coverage

      - name: Verify lcov exists
        shell: bash
        run: |
          test -f "${{ env.APP_DIR }}/coverage/lcov.info" \
            && echo "✅ lcov found" \
            || (echo "❌ lcov missing" && exit 1)

      - name: SonarQube Local Scan
        uses: SonarSource/sonarqube-scan-action@v5.0.0
        env:
          SONAR_HOST_URL: http://localhost:9000
          SONAR_TOKEN: ${{ secrets.SONARQUBE_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=${{ github.repository_owner }}_${{ github.event.repository.name }}_local
            -Dsonar.projectName=netflix-clone-local
            -Dsonar.sources=${{ env.APP_DIR }}/src
            -Dsonar.exclusions=**/node_modules/**,**/dist/**,**/build/**,**/coverage/**,**/*.min.js
            -Dsonar.javascript.lcov.reportPaths=${{ env.APP_DIR }}/coverage/lcov.info

  owasp_dependency_check:
    runs-on: ubuntu-latest
    needs: [mirror_trivy_push_gitops]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: OWASP Dependency-Check (Node)
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: "netflix-devsecops"
          path: "${{ env.APP_DIR }}"
          format: "HTML"
          out: "reports"
          args: "--noupdate --disableYarnAudit"

      - name: Upload OWASP report
        uses: actions/upload-artifact@v4
        with:
          name: owasp-dependency-check-report
          path: reports

  notify_on_failure:
    runs-on: ubuntu-latest
    needs: [mirror_trivy_push_gitops, sonarqube_local, owasp_dependency_check]
    if: failure()

    steps:
      - name: Notify Slack
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -z "${SLACK_WEBHOOK_URL}" ]; then
            echo "SLACK_WEBHOOK_URL not set - skipping"
            exit 0
          fi
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"❌ DevSecOps pipeline failed on ${GITHUB_REPOSITORY} @ ${GITHUB_SHA::7}.\"}" \
            "${SLACK_WEBHOOK_URL}"

      - name: Notify Teams
        env:
          TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}
        run: |
          if [ -z "${TEAMS_WEBHOOK_URL}" ]; then
            echo "TEAMS_WEBHOOK_URL not set - skipping"
            exit 0
          fi
          curl -H "Content-Type: application/json" \
            -d "{\"text\":\"❌ DevSecOps pipeline failed on ${GITHUB_REPOSITORY} @ ${GITHUB_SHA::7}.\"}" \
            "${TEAMS_WEBHOOK_URL}"
