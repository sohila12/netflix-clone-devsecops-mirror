name: Netflix Mirror DevSecOps Pipeline (Trivy + GitOps + Notifications)

on:
  workflow_dispatch:
  push:
    branches: ["main"]

permissions:
  contents: write

env:
  SOURCE_IMAGE: mostafagheta/netflix-clone:latest
  TARGET_REPO: sohila11/netflix-clone

jobs:
  mirror-scan-push-gitops:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set image tag
        id: vars
        run: |
          SHORT_SHA="${GITHUB_SHA::7}"
          echo "tag=main-${SHORT_SHA}" >> "$GITHUB_OUTPUT"

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Pull source image (Mostafa)
        run: |
          docker pull "${SOURCE_IMAGE}"

      - name: Tag image for my DockerHub
        run: |
          docker tag "${SOURCE_IMAGE}" "${TARGET_REPO}:${{ steps.vars.outputs.tag }}"

      - name: Trivy scan (image)
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8
        with:
          image-ref: "${{ env.TARGET_REPO }}:${{ steps.vars.outputs.tag }}"
          format: "table"
          exit-code: "0"
          vuln-type: "os,library"
          severity: "CRITICAL,HIGH,MEDIUM"

      - name: Trivy scan (k8s misconfig)
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8
        with:
          scan-type: "config"
          scan-ref: "Kubernetes"
          format: "table"
          exit-code: "0"
          severity: "CRITICAL,HIGH,MEDIUM"

      - name: Push image to my DockerHub
        run: |
          docker push "${TARGET_REPO}:${{ steps.vars.outputs.tag }}"

      - name: Update deployment image tag (GitOps trigger)
        run: |
          set -e
          FILE="Kubernetes/deployment.yml"
          NEW_IMAGE="${TARGET_REPO}:${{ steps.vars.outputs.tag }}"
          perl -0777 -pi -e "s|(^\\s*image:\\s*).*$|\\1$NEW_IMAGE|mg" "$FILE"
          echo "Updated image to: $NEW_IMAGE"
          grep -n "image:" "$FILE" | head -n 5

      - name: Commit & push manifest change
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Kubernetes/deployment.yml

          if git diff --cached --quiet; then
            echo "No manifest changes"
            exit 0
          fi

          git commit -m "chore(gitops): deploy image ${TARGET_REPO}:${{ steps.vars.outputs.tag }}"
          git push

      - name: Notify Slack on failure (optional)
        if: failure()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -z "${SLACK_WEBHOOK_URL}" ]; then
            echo "SLACK_WEBHOOK_URL not set - skipping"
            exit 0
          fi
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"❌ Netflix pipeline failed on ${GITHUB_REPOSITORY} @ ${GITHUB_SHA::7}.\"}" \
            "${SLACK_WEBHOOK_URL}"

      - name: Notify Teams on failure (optional)
        if: failure()
        env:
          TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}
        run: |
          if [ -z "${TEAMS_WEBHOOK_URL}" ]; then
            echo "TEAMS_WEBHOOK_URL not set - skipping"
            exit 0
          fi
          curl -H "Content-Type: application/json" \
            -d "{\"text\":\"❌ Netflix pipeline failed on ${GITHUB_REPOSITORY} @ ${GITHUB_SHA::7}.\"}" \
            "${TEAMS_WEBHOOK_URL}"
